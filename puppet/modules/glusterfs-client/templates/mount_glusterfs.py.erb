#!/usr/bin/env python

import os
import random

glusterfs_nodes_list = '<%= glusterfs_nodes_list %>'.split(' ')

ipaddr = os.popen("cat /etc/hosts | grep `hostname` | grep -v 127.0.1.1 | awk '{print $1}'").read().rstrip()
if ipaddr in glusterfs_nodes_list:
    glusterfs_nodes_list.remove(ipaddr)

gluster_host = glusterfs_nodes_list[random.randint(0, len(glusterfs_nodes_list) - 1)]

fstab = open('/etc/fstab', 'a')
fstab_content = open('/etc/fstab', 'r').read()

if 'glusterfs' not in fstab_content:
    fstab.write(""+gluster_host+":eccp-nova /opt/stack/data/nova/instances glusterfs defaults 0 0\n")
    fstab.write(""+gluster_host+":eccp-cinder /opt/stack/data/cinder/volumes glusterfs defaults 0 0\n")
    fstab.write(""+gluster_host+":eccp-glance /opt/stack/data/glance/images glusterfs defaults 0 0\n")
else:
    pass
fstab.close()
os.system("mount -a")
